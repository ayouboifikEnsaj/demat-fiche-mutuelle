<div class="container mt-4">
  <!-- Filtres -->
  <div class="row g-3 mb-4 align-items-end">
    <!-- Date Consultation -->
    <div class="col-md-3">
      <label for="dateConsultation" class="form-label">{{ 'CONSULTATION.DATE' | translate }}</label>
      <input type="date" id="dateConsultation" class="form-control"
             [(ngModel)]="dateConsultation"
             (change)="filterFiches()">
    </div>

    <!-- Date Soumission -->
    <div class="col-md-3">
      <label for="dateSoumission" class="form-label">{{ 'SUBMITION.DATE' | translate }}</label>
      <input type="date" id="dateSoumission" class="form-control"
             [(ngModel)]="dateSoumission"
             (change)="filterFiches()">
    </div>

    <!-- Numéro Dossier -->
<!--    <div class="col-md-2">-->
<!--      <label for="numDossier" class="form-label">{{ 'DOSSIER.NUMERO' | translate }}</label>-->
<!--      <div class="position-relative">-->
<!--        <input type="text" id="numDossier" class="form-control pe-5"-->
<!--               [(ngModel)]="numDossier"-->
<!--               (input)="filterFiches()"-->
<!--               placeholder="N°Dossier">-->
<!--        <i class="bi bi-search position-absolute end-0 top-50 translate-middle-y me-3"></i>-->
<!--      </div>-->
<!--    </div>-->
    <!-- Numéro Dossier avec ouverture automatique -->
    <div class="col-md-2">
      <label for="numDossier" class="form-label">{{ 'DOSSIER.NUMERO' | translate }}</label>
      <div class="position-relative">
        <input type="text" id="numDossier" class="form-control pe-5"
               [(ngModel)]="numDossier"
               (input)="onNumDossierChange($event)"
               #numDossierInput
               placeholder="N°Dossier">
        <i class="bi bi-search position-absolute end-0 top-50 translate-middle-y me-3"></i>
      </div>
    </div>

    <!-- Statut + Bouton Export -->
    <div class="col-md-4 d-flex align-items-end">
      <div class="flex-grow-1 me-2">
        <label for="statut" class="form-label">{{'FICHE.STATUT' | translate}}</label>
        <select id="statut" class="form-select" [(ngModel)]="statut" (change)="filterFiches()">
          <option value="">{{'FILTRE.STATUT.TOUS' | translate}}</option>
          <option value="ENATTENTE">{{'FILTRE.STATUT.ENATTENTE' | translate}}</option>
          <option value="VALIDEE">{{'FILTRE.STATUT.VALIDEE' | translate}}</option>
          <option value="REJETEE">{{'FILTRE.STATUT.REJETEE' | translate}}</option>
          <option value="RETOURCOMPLEMENT">{{'FILTRE.STATUT.RETOURCOMPLEMENT' | translate}}</option>
        </select>
      </div>
      <div class="mb-0">
        <label class="form-label d-block invisible">.</label>
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportModal">
          {{'BOUTON_EXPORT' | translate}}
        </button>
      </div>
    </div>
  </div>

  <!-- Tableau -->
  <table class="table table-striped table-bordered">
    <thead class="table-dark">
    <tr>
      <th>{{'TABLE.HEADERS.NUM_DOSSIER' | translate}}</th>
      <th>{{'TABLE.HEADERS.NOM_PRENOM' | translate}}</th>
      <th>{{'TABLE.HEADERS.TYPE_PATIENT' | translate}}</th>
      <th>{{'CONSULTATION.DATE' | translate}}</th>
      <th>{{'TABLE.HEADERS.STATUT' | translate}}</th>
      <th>{{'TABLE.HEADERS.MONTANT' | translate}}</th>
      <th>{{'TABLE.HEADERS.ACTIONS' | translate}}</th>
    </tr>
    </thead>
    <tbody>
    <tr *ngFor="let fiche of paginatedFiches">
      <td>{{ fiche.numDossier }}</td>
      <td>{{ fiche.employee.firstName }} {{ fiche.employee.lastName }}</td>
      <td>{{ ('PATIENT.' + getPatientKey(fiche.typePatient)) | translate }}</td>
      <td>{{ fiche.dateConsultation | date: 'dd/MM/yyyy' }}</td>
      <td>{{ getStatutKey(fiche.statutFiche) | translate }}</td>
      <td>{{ fiche.montantTotal }} MAD</td>
      <td class="text-center">
        <div class="d-inline-flex align-items-center gap-2">
          <button
            class="btn btn-sm btn-outline-primary text-nowrap"
            [routerLink]="['/fiche-gestionnaire', fiche.id]">
            {{ 'TABLE.BUTTON.DETAILS' | translate }}
          </button>
          <button
            class="btn btn-sm btn-primary"
            [routerLink]="['/fiches', fiche.id, 'edit-gestionnaire']"
            [disabled]="fiche.statutFiche !== 'En_attente'">
            Update
          </button>
        </div>
      </td>
    </tr>

    <tr *ngIf="filteredFiches.length === 0">
      <td colspan="7" class="text-center">{{'NO_RESULTS' | translate}}</td>
    </tr>
    </tbody>
  </table>

  <!-- Pagination -->
  <nav *ngIf="totalPages > 1" class="d-flex justify-content-center mt-3">
    <ul class="pagination">
      <li class="page-item" [class.disabled]="currentPage === 1">
        <button class="page-link" (click)="currentPage = currentPage - 1" [disabled]="currentPage === 1">
          &laquo;
        </button>
      </li>

      <li class="page-item" *ngFor="let page of [].constructor(totalPages); let i = index"
          [class.active]="currentPage === i + 1">
        <button class="page-link" (click)="currentPage = i + 1">{{ i + 1 }}</button>
      </li>

      <li class="page-item" [class.disabled]="currentPage === totalPages">
        <button class="page-link" (click)="currentPage = currentPage + 1" [disabled]="currentPage === totalPages">
          &raquo;
        </button>
      </li>
    </ul>
  </nav>

  <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportModalLabel">{{'MESSAGE.EXPORT' | translate}}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="startDate" class="form-label">{{'START.DATE' | translate}}</label>
            <input type="date" id="startDate" class="form-control" [(ngModel)]="exportStartDate" name="startDate">
          </div>
          <div class="mb-3">
            <label for="endDate" class="form-label">{{'END.DATE' | translate}}</label>
            <input type="date" id="endDate" class="form-control" [(ngModel)]="exportEndDate" name="endDate">
          </div>
          <div class="mb-3">
            <label for="lieuDepot" class="form-label">{{'LOCAL.DEPOSIT' | translate}}</label>
            <select id="lieuDepot" class="form-select" [(ngModel)]="exportLieuDepot" name="lieuDepot">
              <option [value]="null">-- {{'All' | translate}} --</option>
              <option *ngFor="let lieu of lieuxDepot" [value]="lieu">{{ lieu }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="typeFiche" class="form-label">{{'FOLDER.TYPE' | translate}}</label>
            <select id="typeFiche" class="form-select" [(ngModel)]="exportTypeFiche" name="typeFiche">
              <option [value]="null">-- {{'All' | translate}} --</option>
              <option *ngFor="let type of typesFiche" [value]="type">{{ type }}</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">{{'BUTTON.RESET' | translate}}</button>
          <button class="btn btn-primary" (click)="exportFiches()" data-bs-dismiss="modal">{{'BOUTON_EXPORT' | translate}}</button>
        </div>
      </div>
    </div>
  </div>
</div>
